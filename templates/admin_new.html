{% extends "base.html" %}
{% block content %}
  <h3 class="mb-3">New Post</h3>
  <form method="post" action="/admin/posts" id="newPostForm">
    <div class="mb-3">
      <label class="form-label">Title (曲名)</label>
      <input class="form-control" type="text" name="title" required>
    </div>
    
    <!-- アーティスト選択（権限による分岐） -->
    <div class="mb-3">
      <label class="form-label">Artist</label>
      
      {% if user.is_admin %}
        <!-- 管理者：検索機能付きアーティスト選択 -->
        <div class="position-relative">
          <input 
            type="text" 
            id="artistSearchInput"
            class="form-control" 
            placeholder="アーティスト名を入力して検索..."
            autocomplete="off"
            required
          >
          
          <input type="hidden" name="artist_id" id="selectedArtistId" required>
          
          <div id="artistSuggestList" class="list-group position-absolute w-100 shadow-sm" style="display: none; z-index: 1000; max-height: 250px; overflow-y: auto;">
          </div>
          
          <div id="selectedArtist" class="mt-2" style="display: none;">
            <div class="alert alert-success d-flex justify-content-between align-items-center mb-0">
              <span>
                <strong>選択済み:</strong> <span id="selectedArtistName"></span>
                <span id="selectedArtistBadge" class="badge bg-success ms-1" style="display: none;">自分</span>
              </span>
              <button type="button" class="btn-close btn-sm" id="clearSelection" aria-label="選択をクリア"></button>
            </div>
          </div>
        </div>
      {% else %}
        <!-- 一般ユーザー：ドロップダウン選択のみ -->
        <select class="form-select" name="artist_id" required>
          {% if my_artists and my_artists|length > 0 %}
            {% for a in my_artists %}
              <option value="{{ a.id }}">{{ a.name }}</option>
            {% endfor %}
          {% else %}
            <option value="" disabled selected>アーティストがありません</option>
          {% endif %}
        </select>
        {% if not my_artists or my_artists|length == 0 %}
          <div class="form-text text-danger">管理者へアーティストの紐付けを依頼してください。</div>
        {% endif %}
      {% endif %}
    </div>
    
    <div class="mb-3">
      <label class="form-label">Description (optional)</label>
      <textarea class="form-control" name="body" rows="3"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">YouTube URL</label>
      <input class="form-control" type="url" name="url_youtube" placeholder="https://www.youtube.com/watch?v=... または https://youtu.be/...">
    </div>
    <div class="mb-3">
      <label class="form-label">Spotify URL</label>
      <input class="form-control" type="url" name="url_spotify" placeholder="https://open.spotify.com/track/...">
    </div>
    <div class="mb-3">
      <label class="form-label">Apple Music Embed URL</label>
      <input class="form-control" type="url" name="url_apple" placeholder="https://embed.music.apple.com/...">
    </div>
    <button class="btn btn-primary" type="submit" id="submitButton">Publish</button>
  </form>

<!-- 新規アーティスト作成確認モーダル -->
{% if user.is_admin %}
<div class="modal fade" id="newArtistModal" tabindex="-1" aria-labelledby="newArtistModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newArtistModalLabel">新しいアーティストを作成</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>「<strong id="newArtistName"></strong>」が見つかりませんでした。</p>
        <p>新しいアーティストとして登録しますか？</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" id="createNewArtistBtn">
          <span id="createButtonText">作成する</span>
          <div class="spinner-border spinner-border-sm ms-2" role="status" id="createSpinner" style="display: none;">
            <span class="visually-hidden">Loading...</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 管理者のみアーティスト検索機能を有効化
  {% if user.is_admin %}
    const searchInput = document.getElementById('artistSearchInput');
    const suggestList = document.getElementById('artistSuggestList');
    const selectedArtistId = document.getElementById('selectedArtistId');
    const selectedArtist = document.getElementById('selectedArtist');
    const selectedArtistName = document.getElementById('selectedArtistName');
    const selectedArtistBadge = document.getElementById('selectedArtistBadge');
    const clearSelection = document.getElementById('clearSelection');
    const submitButton = document.getElementById('submitButton');
    const newPostForm = document.getElementById('newPostForm');
    
    // モーダル関連
    const newArtistModal = new bootstrap.Modal(document.getElementById('newArtistModal'));
    const newArtistName = document.getElementById('newArtistName');
    const createNewArtistBtn = document.getElementById('createNewArtistBtn');
    const createButtonText = document.getElementById('createButtonText');
    const createSpinner = document.getElementById('createSpinner');
    
    let searchTimeout;
    let currentSearchTerm = '';
    
    // 文字列の正規化（大文字小文字・特殊文字を無視した比較用）
    function normalizeString(str) {
      return str.toLowerCase()
        .replace(/[çćč]/g, 'c')
        .replace(/[ñń]/g, 'n')
        .replace(/[üúù]/g, 'u')
        .replace(/[éèê]/g, 'e')
        .replace(/[áà]/g, 'a')
        .replace(/[íì]/g, 'i')
        .replace(/[óò]/g, 'o')
        .replace(/[åä]/g, 'a')
        .replace(/[öø]/g, 'o');
    }
    
    // 検索入力処理
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      currentSearchTerm = query;
      
      // 選択をクリア
      clearArtistSelection();
      
      if (query.length >= 1) {
        searchTimeout = setTimeout(() => {
          searchArtists(query);
        }, 300);
      } else {
        suggestList.style.display = 'none';
      }
    });
    
    // フォーカスアウト時の処理（少し遅延を入れる）
    searchInput.addEventListener('blur', function() {
      setTimeout(() => {
        if (document.activeElement !== suggestList) {
          suggestList.style.display = 'none';
        }
      }, 200);
    });
    
    // アーティスト検索
    async function searchArtists(query) {
      try {
        const response = await fetch(`/api/artists/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.artists && data.artists.length > 0) {
          showArtistSuggestions(data.artists, query);
        } else {
          showNoResultsMessage(query);
        }
      } catch (error) {
        console.error('検索エラー:', error);
        suggestList.style.display = 'none';
      }
    }
    
    // 検索結果表示
    function showArtistSuggestions(artists, query) {
      suggestList.innerHTML = '';
      
      // 完全一致のアーティストがあるかチェック
      const exactMatch = artists.find(artist => 
        normalizeString(artist.name) === normalizeString(query)
      );
      
      // 既存のアーティスト選択肢を表示
      artists.forEach(artist => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        
        // アーティスト名をハイライト
        const highlightedName = highlightMatch(artist.name, query);
        const nameSpan = document.createElement('span');
        nameSpan.innerHTML = highlightedName;
        item.appendChild(nameSpan);
        
        // バッジ表示
        if (artist.is_mine) {
          const badge = document.createElement('span');
          badge.className = 'badge bg-success';
          badge.textContent = '自分';
          item.appendChild(badge);
        }
        
        // クリック処理
        item.addEventListener('click', function() {
          selectArtist(artist);
        });
        
        suggestList.appendChild(item);
      });
      
      // 区切り線を追加
      if (artists.length > 0) {
        const divider = document.createElement('div');
        divider.className = 'list-group-item p-0';
        divider.innerHTML = '<hr class="my-1">';
        suggestList.appendChild(divider);
      }
      
      // 新規作成オプションを追加（完全一致がない場合のみ）
      if (!exactMatch && query.trim()) {
        const newArtistItem = document.createElement('button');
        newArtistItem.type = 'button';
        newArtistItem.className = 'list-group-item list-group-item-action text-center';
        newArtistItem.innerHTML = `
          <div class="d-flex align-items-center justify-content-center">
            <i class="bi bi-plus-circle me-2"></i>
            <span>「<strong>${escapeHtml(query)}</strong>」を新しいアーティストとして作成</span>
          </div>
          <small class="text-muted">クリックして作成</small>
        `;
        
        newArtistItem.addEventListener('click', function() {
          showNewArtistModal(query);
        });
        
        suggestList.appendChild(newArtistItem);
      }
      
      suggestList.style.display = 'block';
    }
    
    // 結果なしの場合
    function showNoResultsMessage(query) {
      suggestList.innerHTML = '';
      
      const noResultItem = document.createElement('button');
      noResultItem.type = 'button';
      noResultItem.className = 'list-group-item list-group-item-action text-center';
      noResultItem.innerHTML = `
        <div class="text-muted mb-2">「${escapeHtml(query)}」が見つかりませんでした</div>
        <div class="d-flex align-items-center justify-content-center">
          <i class="bi bi-plus-circle me-2"></i>
          <span>新しいアーティストとして作成</span>
        </div>
        <small class="text-muted">クリックして作成</small>
      `;
      
      noResultItem.addEventListener('click', function() {
        showNewArtistModal(query);
      });
      
      suggestList.appendChild(noResultItem);
      suggestList.style.display = 'block';
    }
    
    // 検索語のハイライト
    function highlightMatch(text, query) {
      const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
      return escapeHtml(text).replace(regex, '<mark>$1</mark>');
    }
    
    // HTML エスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 正規表現エスケープ
    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    // アーティスト選択
    function selectArtist(artist) {
      selectedArtistId.value = artist.id;
      selectedArtistName.textContent = artist.name;
      
      if (artist.is_mine) {
        selectedArtistBadge.style.display = 'inline';
      } else {
        selectedArtistBadge.style.display = 'none';
      }
      
      searchInput.value = artist.name;
      selectedArtist.style.display = 'block';
      suggestList.style.display = 'none';
      
      // 送信ボタンを有効化
      updateSubmitButton();
    }
    
    // 選択をクリア
    function clearArtistSelection() {
      selectedArtistId.value = '';
      selectedArtist.style.display = 'none';
      updateSubmitButton();
    }
    
    // 選択クリアボタン
    clearSelection.addEventListener('click', function() {
      clearArtistSelection();
      searchInput.value = '';
      searchInput.focus();
    });
    
    // 送信ボタンの状態更新
    function updateSubmitButton() {
      submitButton.disabled = !selectedArtistId.value;
    }
    
    // 新規アーティスト作成モーダル表示
    function showNewArtistModal(artistName) {
      newArtistName.textContent = artistName;
      suggestList.style.display = 'none';
      newArtistModal.show();
    }
    
    // 新規アーティスト作成
    createNewArtistBtn.addEventListener('click', async function() {
      const artistName = newArtistName.textContent;
      
      // ボタンを無効化してローディング表示
      createNewArtistBtn.disabled = true;
      createButtonText.textContent = '作成中...';
      createSpinner.style.display = 'inline-block';
      
      try {
        const formData = new FormData();
        formData.append('name', artistName);
        
        const response = await fetch('/api/artists/create', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
          // 作成成功：アーティストを選択状態にする
          selectArtist(data.artist);
          newArtistModal.hide();
          
          // 成功メッセージ（オプション）
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-success alert-dismissible fade show';
          successAlert.innerHTML = `
            <strong>作成完了！</strong> 「${escapeHtml(data.artist.name)}」を新しいアーティストとして登録しました。
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          newPostForm.insertBefore(successAlert, newPostForm.firstChild);
          
          // 3秒後に自動で非表示
          setTimeout(() => {
            if (successAlert.parentNode) {
              successAlert.remove();
            }
          }, 3000);
          
        } else {
          // エラー表示
          alert(data.error || 'アーティストの作成に失敗しました');
        }
        
      } catch (error) {
        console.error('アーティスト作成エラー:', error);
        alert('アーティストの作成に失敗しました');
      } finally {
        // ボタンを元に戻す
        createNewArtistBtn.disabled = false;
        createButtonText.textContent = '作成する';
        createSpinner.style.display = 'none';
      }
    });
    
    // フォーム送信時のバリデーション（管理者用）
    newPostForm.addEventListener('submit', function(e) {
      if (!selectedArtistId.value) {
        e.preventDefault();
        alert('アーティストを選択してください');
        searchInput.focus();
        return false;
      }
    });
    
    // 初期状態では送信ボタンを無効化
    updateSubmitButton();
    
  {% else %}
    // 一般ユーザー：ドロップダウン選択のバリデーション
    const newPostForm = document.getElementById('newPostForm');
    
    newPostForm.addEventListener('submit', function(e) {
      const artistSelect = document.querySelector('select[name="artist_id"]');
      if (!artistSelect || !artistSelect.value) {
        e.preventDefault();
        alert('アーティストを選択してください');
        if (artistSelect) artistSelect.focus();
        return false;
      }
    });
  {% endif %}
});
</script>

<style>
/* アーティスト選択UI用のスタイル */
#artistSuggestList {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  background: white;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

#artistSuggestList .list-group-item {
  border: none;
  border-bottom: 1px solid #dee2e6;
}

#artistSuggestList .list-group-item:last-child {
  border-bottom: none;
}

#artistSuggestList .list-group-item:hover {
  background-color: #f8f9fa;
}

/* 新規作成オプションのスタイル */
#artistSuggestList .list-group-item:last-child {
  background-color: #f8f9fa;
  border: 2px dashed #6c757d;
  border-radius: 0.375rem;
  margin: 4px;
}

#artistSuggestList .list-group-item:last-child:hover {
  background-color: #e9ecef;
  border-color: #495057;
}

/* 区切り線のスタイル */
#artistSuggestList .list-group-item hr {
  margin: 0.5rem 0;
  border-color: #dee2e6;
}

/* ハイライト */
mark {
  background-color: #fff3cd;
  padding: 0;
}

/* 選択済み表示のスタイル調整 */
#selectedArtist .alert {
  border-left: 4px solid #198754;
}

/* 送信ボタンの無効状態 */
#submitButton:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}

/* モーダルのスタイル調整 */
.modal-body strong {
  color: #0d6efd;
}

/* スピナーのスタイル */
.spinner-border-sm {
  width: 1rem;
  height: 1rem;
}
</style>

{% endblock %}